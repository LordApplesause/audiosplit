#!/usr/bin/env ruby
require 'rubygems'
require 'json'
$:.unshift File.expand_path(File.dirname(__FILE__))
require 'revision'

if ARGV.size == 0
  puts "usage #{$0} input.wav"
  exit 1
end

input = ARGV[0]

system("./splitter -i #{input} -t 15 -d 0.3")
path = File.dirname(input)

results = []
confidence = 0
count = 0
root_name = File.basename(input).gsub(/\.wav$/,'')
=begin
[["0"], ["0"]]
[["0"], ["1"]]
[["0"], ["2"]]
[["0"], ["3"]]
[["0"], ["8"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["0"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["3"], ["1"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["3"], ["7"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["3"], ["8"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["3"], ["9"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["4"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["6"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["7"]]
[["1"], ["1"], ["3"], ["0"], ["1"], ["8"]]
[["1"], ["1"], ["3"], ["0"], ["4"], ["3"]]
[["1"], ["1"], ["3"], ["0"], ["4"], ["4"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["1"], ["5"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["6"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["7"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["1"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["1"], ["7"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["1"], ["8"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["2"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["2"], ["0"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["3"]]
[["1"], ["1"], ["3"], ["0"], ["7"], ["8"], ["6"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["0"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["1"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["2"], ["0"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["2"], ["1"], ["1"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["2"], ["7"]]
[["1"], ["1"], ["3"], ["1"], ["1"], ["2"], ["8"]]
[["1"], ["1"], ["3"], ["2"]]
[["1"], ["1"], ["3"], ["4"], ["1"], ["9"], ["1"]]
[["1"], ["1"], ["3"], ["4"], ["1"], ["9"], ["2"]]
[["1"], ["1"], ["3"], ["4"], ["1"], ["9"], ["3"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["0"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["1"], ["1"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["1"], ["2"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["1"], ["3"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["1"], ["4"]]
[["1"], ["1"], ["3"], ["4"], ["2"], ["1"], ["5"]]
[["1"], ["1"], ["3"], ["4"], ["3"]]
[["1"], ["1"], ["3"], ["4"], ["5"]]
[["1"], ["1"], ["3"], ["4"], ["8"]]
[["1"], ["1"], ["4"], ["1"], ["0"]]
[["1"], ["1"], ["4"], ["1"], ["2"]]
[["1"], ["1"], ["4"], ["1"], ["3"]]
[["1"], ["1"], ["4"], ["2"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["0"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["1"], ["0"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["1"], ["3"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["1"], ["4"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["1"], ["5"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["1"], ["9"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["2"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["2"], ["7"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["2"], ["8"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["3"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["3"], ["2"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["3"], ["3"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["3"], ["8"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["4"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["7"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["8"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["0"], ["9"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["3"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["5"]]
[["1"], ["1"], ["5"], ["1"], ["0"], ["6"]]
[["1"], ["1"], ["5"], ["1"], ["1"]]
[["1"], ["1"], ["5"], ["1"], ["4"]]
[["1"], ["2"]]
[["2"]]
[["3"]]
[["4"]]
[["8"]]
[["9"]]
=end

# it's important that contiguous chunks stay connected otherwise partial words might be sent for transcribing
chunks = Dir["#{path}/#{root_name}*.wav.chunk*"].sort do|a, b|
  da = a.scan(/(\d+)/)
  dav = da.flatten.join(".")

  db = b.scan(/(\d+)/)
  dbv = db.flatten.join(".")
  
  Revision.new(dav) <=> Revision.new(dbv)
end

puts chunks.map{|c| puts c }.inspect

chunks.each do|wave|
  puts wave.inspect
  chunk_file = wave.gsub(/\.wav/,'') + ".wav"
  system("mv #{wave} #{chunk_file}")
  system("speech2text #{chunk_file}")
  wave_text = chunk_file.gsub(/\.wav$/,'.json')
  if File.exist?(wave_text)
    out = JSON.parse(File.read(wave_text))
    if out && out['hypotheses'] && !out['hypotheses'].empty?
      results << out['hypotheses'].first.first
      confidence += out['hypotheses'].first.last
      count += 1
    end
  end
end

if chunks.size == 0
  # send the original file
  system("speech2text #{input}")
  wave_text = input.gsub(/\.wav$/,'.json')
  if File.exist?(wave_text)
    out = JSON.parse(File.read(wave_text))
    if out && out['hypotheses'] && !out['hypotheses'].empty?
      results << out['hypotheses'].first.first
      confidence += out['hypotheses'].first.last
      count += 1
    end
  end
end

puts chunks.inspect

confidence /= count
puts results.join(" ")
puts confidence
